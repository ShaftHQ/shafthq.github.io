name: Secret Scanning

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for all branches
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only required for Organizations, not personal repos
  
  verify-build:
    name: Verify No Secrets in Build Output
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install
      
      - name: Build site
        run: yarn build
      
      - name: Scan build for API key patterns
        run: |
          echo "üîç Scanning build output for potential API keys..."
          
          # Check for Google API key pattern (AIza...) in JavaScript bundles
          if grep -r "AIza[0-9A-Za-z_-]\{35\}" build/assets/ 2>/dev/null; then
            echo "‚ùå ERROR: Found potential Google API key in JavaScript bundles!"
            exit 1
          fi
          
          # Check for any GEMINI_API_KEY references with actual values in bundles
          if grep -r "GEMINI_API_KEY.*AIza" build/assets/ 2>/dev/null; then
            echo "‚ùå ERROR: Found GEMINI_API_KEY with value in JavaScript bundles!"
            exit 1
          fi
          
          # Verify config.json exists and has the expected structure
          if [ -f build/config.json ]; then
            echo "‚úÖ Runtime config.json found in build output (expected)"
            # The config.json is meant to be in the build and served at runtime
            # It's protected by HTTP referrer restrictions, not by obscurity
          else
            echo "‚ö†Ô∏è  Warning: config.json not found in build output"
          fi
          
          echo "‚úÖ No secrets found in JavaScript bundles!"
      
      - name: Upload build artifacts for review
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-with-secrets
          path: build/
          retention-days: 1
