name: Secret Scanning

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for all branches
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only required for Organizations, not personal repos
  
  verify-build:
    name: Verify No Secrets in Build Output
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install
      
      - name: Build site
        run: yarn build
      
      - name: Scan build for API key patterns
        run: |
          echo "üîç Scanning build output for potential API keys..."
          
          # Check for Google API key pattern (AIza...)
          if grep -r "AIza[0-9A-Za-z_-]\{35\}" build/; then
            echo "‚ùå ERROR: Found potential Google API key in build output!"
            exit 1
          fi
          
          # Check for any GEMINI_API_KEY references with actual values
          if grep -r "GEMINI_API_KEY.*AIza" build/; then
            echo "‚ùå ERROR: Found GEMINI_API_KEY with value in build output!"
            exit 1
          fi
          
          # Check for generic API key patterns
          if grep -rE "(api[_-]?key|apikey|api[_-]?secret)['\"]\s*[:=]\s*['\"][a-zA-Z0-9_\-]{30,}['\"]" build/; then
            echo "‚ùå ERROR: Found potential API key in build output!"
            exit 1
          fi
          
          echo "‚úÖ No secrets found in build output!"
      
      - name: Upload build artifacts for review
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-with-secrets
          path: build/
          retention-days: 1
